name: Update Bing Cookies

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  update-cookies:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Playwright
        run: |
          npm install playwright@latest
          npx playwright install chromium

      - name: Create Playwright script
        run: |
          mkdir -p scripts
          cat > scripts/get-bing-cookies.js << 'EOL'
          const { chromium } = require('playwright');
          const fs = require('fs');

          async function getBingCookies() {
            console.log('Launching browser...');
            const browser = await chromium.launch({
              headless: true
            });

            try {
              const context = await browser.newContext({
                userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36'
              });
              const page = await context.newPage();

              console.log('Navigating to Bing...');
              await page.goto('https://cn.bing.com/search?q=Windows', { waitUntil: 'networkidle' });

              // Wait for cookies to be set
              await page.waitForTimeout(3000);

              // Get all cookies
              const cookies = await context.cookies();
              const cookieString = cookies
                .map(cookie => `${cookie.name}=${cookie.value}`)
                .join('; ');

              console.log(`Successfully retrieved ${cookies.length} cookies`);

              // Store in JSON format
              const cookieData = {
                cookie: cookieString,
                timestamp: new Date().toISOString(),
                count: cookies.length
              };

              fs.writeFileSync('bing_cookies.json', JSON.stringify(cookieData, null, 2));
              console.log('Cookies saved to bing_cookies.json');

              return cookieData;
            } catch (error) {
              console.error('Error getting cookies:', error);
              throw error;
            } finally {
              await browser.close();
            }
          }

          getBingCookies()
            .catch(error => {
              console.error('Script failed:', error);
              process.exit(1);
            });
          EOL

      - name: Run Playwright script
        run: node scripts/get-bing-cookies.js

      - name: Verify cookie file
        run: |
          if [ ! -f bing_cookies.json ]; then
            echo "Error: bing_cookies.json not found"
            exit 1
          fi
          echo "Cookie file contents:"
          cat bing_cookies.json

      - name: Update GitHub Gist
        env:
          GIST_ID: ${{ secrets.BING_GIST_ID }}
          GH_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          if [ -z "$GIST_ID" ] || [ -z "$GH_TOKEN" ]; then
            echo "Error: BING_COOKIES_GIST_ID or GH_PAT secrets are not set."
            echo "Please set these secrets in your repository settings."
            exit 1
          fi

          echo "Updating GitHub Gist..."

          # Escape the JSON content for API call
          CONTENT=$(cat bing_cookies.json | jq -Rs .)

          curl -X PATCH \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token $GH_TOKEN" \
            -d "{\"files\": {\"bing_cookies.json\": {\"content\": $CONTENT}}}" \
            https://api.github.com/gists/$GIST_ID

          if [ $? -eq 0 ]; then
            echo "Gist updated successfully!"
          else
            echo "Failed to update Gist"
            exit 1
          fi
