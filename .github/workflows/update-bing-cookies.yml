name: Update Bing Cookie Gist

on:
  # schedule:
  #   # ÊØèÂ§©ÂáåÊô® 2 ÁÇπ (UTC) ËøêË°å‰∏ÄÊ¨°
  #   - cron: '0 2 * * *'
  workflow_dispatch: # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë

jobs:
  update-cookie:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies and browsers
        run: |
          npm install playwright
          npx playwright install --with-deps chromium

      - name: Run Playwright script to fetch cookie
        run: node scripts/get-bing-cookies.js

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || apt-get install curl -y
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && apt update \
          && apt install gh -y

      - name: Verify cookie file exists
        run: |
          if [ ! -f "bing_cookies.json" ]; then
            echo "‚ùå Cookie file not found. Script may have failed."
            exit 1
          fi
          echo "üìÑ Cookie file found. Contents:"
          cat bing_cookies.json

      - name: Update GitHub Gist using gh CLI
        env:
          GH_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.BING_GIST_ID }}
        run: |
          # ‰ΩøÁî® gh cli Êõ¥Êñ∞ Gist
          gh gist edit "${{ secrets.BING_GIST_ID }}" bing_cookies.json

          echo "‚úÖ Gist update complete!"
